<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="è¿›é”€å­˜">
<meta name="theme-color" content="#1c2333">
<link rel="manifest" href="./manifest.json">
<title>äº”é‡‘åº—è¿›é”€å­˜</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700;900&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --ink:     #1c2333;
  --ink2:    #2d3748;
  --steel:   #3d4f6b;
  --muted:   #7a8899;
  --paper:   #f4f0e8;
  --warm:    #ede8df;
  --orange:  #e07b2a;
  --orange2: #c9651a;
  --gold:    #d4a520;
  --red:     #c0392b;
  --green:   #2e7d52;
  --white:   #ffffff;
  --border:  rgba(61,79,107,0.15);
  --card-shadow: 0 2px 12px rgba(28,35,51,0.10), 0 1px 3px rgba(28,35,51,0.08);
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bot: env(safe-area-inset-bottom, 0px);
}

*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;font-family:'Noto Sans SC',sans-serif;background:var(--ink);color:var(--ink)}

/* â”€â”€ Layout â”€â”€ */
#app{display:flex;flex-direction:column;height:100%;height:100dvh}
.topbar{
  background:var(--ink);
  padding: calc(var(--safe-top) + 10px) 18px 12px;
  flex-shrink:0;
}
.topbar-inner{display:flex;align-items:center;gap:10px}
.topbar-icon{font-size:28px;line-height:1}
.topbar-name{font-family:'Noto Serif SC',serif;font-size:20px;font-weight:900;color:var(--white);letter-spacing:.03em}
.topbar-sub{font-size:11px;color:rgba(255,255,255,.45);margin-top:1px}
.topbar-spacer{flex:1}
.topbar-badge{background:var(--orange);color:#fff;font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px}

.pages{flex:1;overflow:hidden;position:relative;background:var(--paper)}
.page{
  position:absolute;inset:0;
  overflow-y:auto;-webkit-overflow-scrolling:touch;
  padding:16px 14px calc(var(--safe-bot) + 76px);
  opacity:0;pointer-events:none;transition:opacity .18s;
}
.page.active{opacity:1;pointer-events:auto}

.bottomnav{
  background:var(--ink);
  padding:0 0 calc(var(--safe-bot) + 4px);
  display:flex;flex-shrink:0;
}
.nav-btn{
  flex:1;display:flex;flex-direction:column;align-items:center;
  padding:12px 0 8px;border:none;background:none;color:rgba(255,255,255,.4);
  font-size:10px;gap:4px;cursor:pointer;transition:color .15s;position:relative;
}
.nav-btn.on{color:var(--orange)}
.nav-btn.on::after{
  content:'';position:absolute;top:0;left:25%;right:25%;
  height:2px;background:var(--orange);border-radius:0 0 3px 3px;
}
.nav-btn svg{width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
.nav-label{font-family:'Noto Sans SC';font-size:10px;font-weight:500}

/* â”€â”€ Cards â”€â”€ */
.card{
  background:var(--white);border-radius:16px;
  box-shadow:var(--card-shadow);margin-bottom:12px;overflow:hidden;
}
.card-head{
  padding:14px 16px 0;display:flex;align-items:center;gap:8px;
}
.card-head-icon{
  width:34px;height:34px;border-radius:10px;
  background:var(--ink);display:flex;align-items:center;justify-content:center;
  font-size:17px;flex-shrink:0;
}
.card-head-title{font-family:'Noto Serif SC',serif;font-size:16px;font-weight:700;color:var(--ink)}
.card-head-sub{font-size:11px;color:var(--muted);margin-top:1px}
.card-body{padding:12px 16px 16px}

/* â”€â”€ Metrics â”€â”€ */
.metrics{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.metric{
  background:var(--ink);border-radius:14px;padding:16px 14px;
  position:relative;overflow:hidden;
}
.metric::before{
  content:attr(data-icon);position:absolute;right:-4px;top:-4px;
  font-size:52px;opacity:.12;line-height:1;
}
.metric-label{font-size:11px;color:rgba(255,255,255,.5);margin-bottom:6px;font-weight:500}
.metric-val{font-family:'Noto Serif SC',serif;font-size:28px;font-weight:900;color:var(--white);line-height:1}
.metric-val.orange{color:var(--orange)}
.metric-val.red{color:#ff7070}
.metric-val.green{color:#5dba8a}

/* â”€â”€ Form â”€â”€ */
.field{margin-bottom:13px}
.field label{display:block;font-size:12px;color:var(--muted);font-weight:600;margin-bottom:5px;text-transform:uppercase;letter-spacing:.04em}
.field input,.field select,.field textarea{
  width:100%;padding:12px 14px;
  border:2px solid var(--border);border-radius:11px;
  font-size:16px;font-family:'Noto Sans SC',sans-serif;color:var(--ink);
  background:var(--paper);outline:none;transition:border-color .15s;
  appearance:none;-webkit-appearance:none;
}
.field input:focus,.field select:focus{border-color:var(--orange);background:#fff}
.field select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='%237a8899'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

/* â”€â”€ Buttons â”€â”€ */
.btn{
  display:flex;align-items:center;justify-content:center;gap:8px;
  width:100%;padding:15px;border-radius:12px;border:none;
  font-size:16px;font-family:'Noto Sans SC',sans-serif;font-weight:700;
  cursor:pointer;transition:transform .1s,opacity .15s;
  letter-spacing:.03em;
}
.btn:active{transform:scale(.97)}
.btn-primary{background:var(--orange);color:#fff}
.btn-primary:active{background:var(--orange2)}
.btn-success{background:var(--green);color:#fff}
.btn-outline{background:transparent;border:2px solid var(--border);color:var(--ink)}
.btn-sm{padding:8px 16px;font-size:13px;border-radius:9px;width:auto}
.btn-danger-sm{background:var(--red);color:#fff}
.btn[disabled]{opacity:.45;pointer-events:none}

/* â”€â”€ Table / List â”€â”€ */
.item-list{margin-top:2px}
.item-row{
  display:flex;align-items:center;padding:12px 0;
  border-bottom:1px solid var(--border);gap:10px;
  transition:background .1s;
}
.item-row:last-child{border-bottom:none}
.item-row.low{background:linear-gradient(90deg,#fff0ee 0,transparent 100%);border-radius:8px;padding-left:6px}
.item-row.editing{background:var(--warm);border-radius:10px;padding:10px 8px}
.item-name{font-size:15px;font-weight:700;color:var(--ink)}
.item-unit{font-size:11px;color:var(--muted);margin-top:2px}
.item-badges{display:flex;gap:6px;margin-left:auto;align-items:center}
.badge{
  padding:5px 10px;border-radius:8px;text-align:center;min-width:56px;
}
.badge-label{font-size:10px;color:inherit;opacity:.7}
.badge-val{font-family:'Noto Serif SC',serif;font-size:17px;font-weight:900;line-height:1.1}
.badge-stock{background:var(--ink);color:var(--white)}
.badge-stock.low{background:var(--red)}
.badge-cost{background:var(--warm);color:var(--ink)}

.inline-edit{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.edit-input{
  width:72px;padding:7px 8px;border:2px solid var(--orange);border-radius:8px;
  font-size:15px;text-align:center;background:#fff;color:var(--ink);font-weight:700;
}
.edit-label{font-size:11px;color:var(--muted);font-weight:600}
.edit-group{display:flex;flex-direction:column;align-items:center;gap:2px}
.save-btn{
  width:36px;height:36px;border-radius:9px;background:var(--green);
  border:none;color:#fff;font-size:20px;font-weight:700;
  display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;
}

/* â”€â”€ Search â”€â”€ */
.search-wrap{position:relative;margin-bottom:10px}
.search-wrap input{padding-left:38px}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:16px;pointer-events:none}

/* â”€â”€ Trans rows â”€â”€ */
.trans-row{
  display:flex;padding:12px 0;border-bottom:1px solid var(--border);gap:10px;
  align-items:flex-start;
}
.trans-row:last-child{border-bottom:none}
.trans-left{flex:1;min-width:0}
.trans-date{font-size:11px;color:var(--muted);margin-bottom:2px}
.trans-name{font-size:15px;font-weight:700;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.trans-meta{font-size:12px;color:var(--muted);margin-top:2px}
.trans-right{text-align:right;flex-shrink:0}
.trans-total{font-family:'Noto Serif SC',serif;font-size:18px;font-weight:900;color:var(--orange)}
.trans-profit{font-size:12px;font-weight:700;margin-top:2px}

/* â”€â”€ Filter chips â”€â”€ */
.filter-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.filter-row .field{margin-bottom:0}
.filter-row .field select{font-size:14px;padding:10px 32px 10px 12px}

/* â”€â”€ Toast â”€â”€ */
#toast{
  position:fixed;bottom:calc(var(--safe-bot) + 82px);left:16px;right:16px;
  background:var(--ink2);color:#fff;padding:14px 18px;border-radius:14px;
  font-size:15px;font-weight:600;text-align:center;
  z-index:9999;display:none;box-shadow:0 8px 32px rgba(0,0,0,.3);
}
#toast.show{display:block;animation:toastIn .25s ease}
#toast.ok{background:var(--green)}
#toast.err{background:var(--red)}
@keyframes toastIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

/* â”€â”€ Dialog â”€â”€ */
.dialog-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:888;
  display:none;align-items:center;justify-content:center;padding:20px;
}
.dialog-overlay.open{display:flex}
.dialog{
  background:#fff;border-radius:20px;padding:24px;width:100%;max-width:340px;
  animation:dialogIn .2s ease;
}
@keyframes dialogIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:none}}
.dialog-title{font-family:'Noto Serif SC',serif;font-size:18px;font-weight:900;margin-bottom:8px;color:var(--ink)}
.dialog-msg{font-size:14px;color:var(--muted);line-height:1.7;margin-bottom:20px}
.dialog-btns{display:flex;gap:10px}
.dialog-cancel{flex:1;padding:13px;border-radius:10px;border:2px solid var(--border);background:#fff;font-size:15px;font-weight:700;color:var(--muted);cursor:pointer}
.dialog-confirm{flex:1;padding:13px;border-radius:10px;border:none;background:var(--red);color:#fff;font-size:15px;font-weight:700;cursor:pointer}

/* â”€â”€ Settings â”€â”€ */
.settings-hero{
  background:var(--ink);border-radius:16px;padding:24px;margin-bottom:12px;
  display:flex;flex-direction:column;align-items:center;gap:6px;
}
.settings-hero-icon{font-size:56px}
.settings-hero-name{font-family:'Noto Serif SC',serif;font-size:22px;font-weight:900;color:#fff}
.settings-hero-sub{font-size:12px;color:rgba(255,255,255,.45)}
.settings-tag{background:var(--orange);color:#fff;font-size:11px;font-weight:700;padding:3px 12px;border-radius:20px;margin-top:4px}

.guide-item{display:flex;gap:12px;padding:13px 0;border-bottom:1px solid var(--border);align-items:flex-start}
.guide-item:last-child{border-bottom:none}
.guide-icon-wrap{width:38px;height:38px;background:var(--ink);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.guide-title{font-size:14px;font-weight:700;color:var(--ink);margin-bottom:3px}
.guide-desc{font-size:12px;color:var(--muted);line-height:1.6}

.warn-box{background:#fff8e1;border-left:3px solid var(--gold);border-radius:8px;padding:10px 12px;margin-bottom:12px;font-size:13px;color:#7a5c00}

/* â”€â”€ Divider â”€â”€ */
.divider{height:1px;background:var(--border);margin:14px 0}

/* â”€â”€ Sync toggle â”€â”€ */
.toggle-row{
  display:flex;align-items:center;justify-content:space-between;
  background:var(--warm);border-radius:10px;padding:11px 14px;margin-bottom:12px;
}
.toggle-label{font-size:13px;color:var(--muted);font-weight:500;flex:1;padding-right:12px;line-height:1.5}
.toggle{position:relative;width:48px;height:27px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{
  position:absolute;inset:0;background:#ccc;border-radius:27px;
  cursor:pointer;transition:.25s;
}
.toggle-slider:before{
  content:'';position:absolute;height:21px;width:21px;
  left:3px;bottom:3px;background:#fff;border-radius:50%;
  transition:.25s;box-shadow:0 1px 4px rgba(0,0,0,.2);
}
.toggle input:checked + .toggle-slider{background:var(--orange)}
.toggle input:checked + .toggle-slider:before{transform:translateX(21px)}

/* â”€â”€ Preview box â”€â”€ */
.preview-box{
  background:var(--ink);border-radius:11px;padding:13px 16px;
  margin-bottom:13px;display:flex;align-items:center;justify-content:space-between;
}
.preview-label{font-size:12px;color:rgba(255,255,255,.5);font-weight:600}
.preview-val{font-family:'Noto Serif SC',serif;font-size:22px;font-weight:900;color:var(--orange)}

/* â”€â”€ Existing item info â”€â”€ */
.info-pill{
  background:var(--warm);border-radius:10px;padding:10px 14px;
  margin-bottom:13px;font-size:14px;color:var(--steel);font-weight:600;
  border-left:3px solid var(--orange);
}

/* â”€â”€ Empty â”€â”€ */
.empty-state{padding:40px 20px;text-align:center}
.empty-icon{font-size:48px;display:block;margin-bottom:10px;opacity:.5}
.empty-text{font-size:15px;color:var(--muted)}
.empty-sub{font-size:12px;color:var(--border);margin-top:6px}

/* â”€â”€ Loading â”€â”€ */
.loading{text-align:center;padding:30px;color:var(--muted);font-size:14px}

/* â”€â”€ Low stock warning â”€â”€ */
.low-alert{
  background:linear-gradient(135deg,#c0392b,#e74c3c);
  color:#fff;border-radius:8px;padding:5px 10px;font-size:11px;font-weight:700;
  display:inline-flex;align-items:center;gap:4px;
}
</style>
</head>
<body>
<div id="app">

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-inner">
    <span class="topbar-icon">ğŸ”§</span>
    <div>
      <div class="topbar-name">äº”é‡‘åº—è¿›é”€å­˜</div>
      <div class="topbar-sub">æ•°æ®æœ¬åœ°å­˜å‚¨ Â· ç¦»çº¿å¯ç”¨</div>
    </div>
    <div class="topbar-spacer"></div>
    <div class="topbar-badge" id="hdr-date"></div>
  </div>
</div>

<!-- PAGES -->
<div class="pages">

  <!-- â•â•â•â• åº“å­˜é¡µ â•â•â•â• -->
  <div class="page active" id="page-inv">
    <div class="metrics">
      <div class="metric" data-icon="ğŸ“¦">
        <div class="metric-label">å•†å“ç§ç±»</div>
        <div class="metric-val orange" id="m-total">â€”</div>
      </div>
      <div class="metric" data-icon="âš ï¸">
        <div class="metric-label">ä½åº“å­˜å•†å“</div>
        <div class="metric-val" id="m-low">â€”</div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-head-icon">ğŸ“‹</div>
        <div><div class="card-head-title">å½“å‰åº“å­˜</div><div class="card-head-sub">ç‚¹å‡»ä»»æ„å•†å“å¯ç¼–è¾‘</div></div>
      </div>
      <div class="card-body">
        <div class="search-wrap">
          <span class="search-icon">ğŸ”</span>
          <input class="field" style="margin:0" id="inv-search" placeholder="æœç´¢å•†å“åç§°â€¦" oninput="renderInv()">
        </div>
        <div class="item-list" id="inv-list"><div class="loading">åŠ è½½ä¸­â€¦</div></div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-head-icon">ğŸ“¥</div>
        <div><div class="card-head-title">è¿›è´§å½•å…¥</div><div class="card-head-sub">æ–°å•†å“æˆ–è¡¥å……åº“å­˜</div></div>
      </div>
      <div class="card-body">
        <div class="field">
          <label>é€‰æ‹©å•†å“</label>
          <select id="rst-sel" onchange="onRstSel()"></select>
        </div>
        <div id="rst-new" style="display:none">
          <div class="field"><label>æ–°å•†å“åç§°</label><input id="rst-name" placeholder="è¾“å…¥åç§°"></div>
          <div class="field"><label>å•ä½</label><select id="rst-unit" onchange="onRstUnit()">
            <option>ä¸ª</option><option>æŠŠ</option><option>ç›’</option><option>å·</option>
            <option>ç±³</option><option>åŒ…</option><option>ç®±</option><option>å¥—</option>
            <option>æ ¹</option><option>æ¡</option><option>ç‰‡</option><option value="__other">å…¶ä»–â€¦</option>
          </select></div>
          <div class="field" id="rst-unit-custom-wrap" style="display:none">
            <label>è‡ªå®šä¹‰å•ä½</label><input id="rst-unit-custom" placeholder="å¦‚ï¼šæ¡¶ã€ç»„â€¦">
          </div>
        </div>
        <div id="rst-exist-info" style="display:none"></div>
        <div class="row2">
          <div class="field"><label>è¿›è´§æ•°é‡</label><input id="rst-qty" type="number" min="0" step="1" placeholder="0"></div>
          <div class="field"><label>è¿›è´§å•ä»·ï¼ˆå…ƒï¼‰</label><input id="rst-price" type="number" min="0" step="0.01" placeholder="0.00"></div>
        </div>
        <div class="field"><label>å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</label><input id="rst-remark" placeholder="é€‰å¡«"></div>
        <button class="btn btn-success" onclick="submitRestock()">âœ… ç¡®è®¤è¿›è´§</button>
      </div>
    </div>
  </div><!-- /page-inv -->

  <!-- â•â•â•â• æµæ°´é¡µ â•â•â•â• -->
  <div class="page" id="page-trans">
    <div class="metrics">
      <div class="metric" data-icon="ğŸ’°">
        <div class="metric-label">ç­›é€‰è¥ä¸šé¢</div>
        <div class="metric-val orange" id="m-rev">Â¥0</div>
      </div>
      <div class="metric" data-icon="ğŸ“ˆ">
        <div class="metric-label">ç­›é€‰åˆ©æ¶¦</div>
        <div class="metric-val" id="m-profit">Â¥0</div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-head-icon">ğŸ”</div>
        <div><div class="card-head-title">ç­›é€‰</div></div>
      </div>
      <div class="card-body">
        <div class="field" style="margin-bottom:8px">
          <input id="t-search" placeholder="æœç´¢å•†å“åç§°â€¦" oninput="renderTrans()">
        </div>
        <div class="filter-row">
          <div class="field"><select id="t-year" onchange="renderTrans()"><option value="">å…¨éƒ¨å¹´ä»½</option></select></div>
          <div class="field"><select id="t-month" onchange="renderTrans()"><option value="">å…¨éƒ¨æœˆä»½</option></select></div>
        </div>
        <div class="field" style="margin:0"><select id="t-date" onchange="renderTrans()"><option value="">å…¨éƒ¨æ—¥æœŸ</option></select></div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-head-icon">ğŸ“’</div>
        <div><div class="card-head-title">æµæ°´è®°å½•</div><div class="card-head-sub" id="trans-count">å…± 0 æ¡</div></div>
      </div>
      <div class="card-body">
        <div class="toggle-row">
          <span class="toggle-label">åˆ é™¤æ—¶åŒæ­¥æ¢å¤åº“å­˜</span>
          <label class="toggle"><input type="checkbox" id="sync-toggle"><span class="toggle-slider"></span></label>
        </div>
        <div id="trans-list"><div class="loading">åŠ è½½ä¸­â€¦</div></div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-head-icon">ğŸ“¤</div>
        <div><div class="card-head-title">å–å‡ºç™»è®°</div><div class="card-head-sub">è‡ªåŠ¨è®¡ç®—åˆ©æ¶¦</div></div>
      </div>
      <div class="card-body">
        <div class="field">
          <label>é€‰æ‹©å•†å“</label>
          <select id="sale-sel" onchange="onSaleSel()"></select>
        </div>
        <div id="sale-new" style="display:none">
          <div class="field"><label>æ–°å•†å“åç§°</label><input id="sale-name" placeholder="è¾“å…¥åç§°"></div>
          <div class="field"><label>å•ä½</label><select id="sale-unit">
            <option>ä¸ª</option><option>æŠŠ</option><option>ç›’</option><option>å·</option>
            <option>ç±³</option><option>åŒ…</option><option>ç®±</option><option>å¥—</option><option>æ ¹</option>
          </select></div>
        </div>
        <div class="row2">
          <div class="field"><label>å–å‡ºæ•°é‡</label><input id="sale-qty" type="number" min="1" step="1" value="1" oninput="updatePreview()"></div>
          <div class="field"><label>å–å‡ºå•ä»·ï¼ˆå…ƒï¼‰</label><input id="sale-price" type="number" min="0" step="0.01" value="0" oninput="updatePreview()"></div>
        </div>
        <div class="preview-box" id="preview-box" style="display:none">
          <span class="preview-label">é¢„è®¡è¿›è´¦</span>
          <span class="preview-val" id="preview-val">Â¥0.00</span>
        </div>
        <button class="btn btn-primary" onclick="submitSale()">ğŸ’° ç¡®è®¤å–å‡ºå…¥è´¦</button>
      </div>
    </div>
  </div><!-- /page-trans -->

  <!-- â•â•â•â• è®¾ç½®é¡µ â•â•â•â• -->
  <div class="page" id="page-settings">
    <div class="settings-hero">
      <span class="settings-hero-icon">ğŸ”§</span>
      <span class="settings-hero-name">äº”é‡‘åº—è¿›é”€å­˜</span>
      <span class="settings-hero-sub">æ•°æ®å®‰å…¨å­˜å‚¨åœ¨æ‰‹æœºæœ¬åœ°</span>
      <span class="settings-tag">v1.0  Â·  ç¦»çº¿å¯ç”¨</span>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-head-icon">ğŸ“¤</div>
        <div><div class="card-head-title">æ•°æ®å¯¼å‡º</div><div class="card-head-sub">å¯¼å‡ºä¸ºCSVï¼Œå¯ç”¨Excelæ‰“å¼€</div></div>
      </div>
      <div class="card-body">
        <button class="btn btn-outline" style="margin-bottom:10px" onclick="exportCSV('inv')">ğŸ“Š å¯¼å‡ºåº“å­˜è¡¨</button>
        <button class="btn btn-outline" onclick="exportCSV('trans')">ğŸ“‹ å¯¼å‡ºæµæ°´è¡¨</button>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-head-icon">ğŸ“¥</div>
        <div><div class="card-head-title">æ•°æ®å¯¼å…¥</div><div class="card-head-sub">å¯¼å…¥åŸæœ‰CSVå†å²æ•°æ®</div></div>
      </div>
      <div class="card-body">
        <div class="warn-box">âš ï¸ å¯¼å…¥å°†ä¸ç°æœ‰æ•°æ®åˆå¹¶ï¼ŒåŒåå•†å“åº“å­˜é‡å’Œæˆæœ¬ä¼šè¢«è¦†ç›–æ›´æ–°</div>
        <button class="btn btn-outline" style="margin-bottom:10px" onclick="document.getElementById('imp-inv').click()">ğŸ“¦ å¯¼å…¥åº“å­˜è¡¨ CSV</button>
        <button class="btn btn-outline" onclick="document.getElementById('imp-trans').click()">ğŸ’° å¯¼å…¥æµæ°´è¡¨ CSV</button>
        <input type="file" id="imp-inv" accept=".csv" style="display:none" onchange="importCSV(this,'inv')">
        <input type="file" id="imp-trans" accept=".csv" style="display:none" onchange="importCSV(this,'trans')">
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="card-head-icon">ğŸ“–</div>
        <div><div class="card-head-title">ä½¿ç”¨è¯´æ˜</div></div>
      </div>
      <div class="card-body">
        <div class="item-list" id="guide-list"></div>
      </div>
    </div>
  </div><!-- /page-settings -->

</div><!-- /pages -->

<!-- BOTTOM NAV -->
<nav class="bottomnav">
  <button class="nav-btn on" id="nav-inv" onclick="switchTab('inv')">
    <svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>
    <span class="nav-label">åº“å­˜</span>
  </button>
  <button class="nav-btn" id="nav-trans" onclick="switchTab('trans')">
    <svg viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
    <span class="nav-label">æµæ°´</span>
  </button>
  <button class="nav-btn" id="nav-settings" onclick="switchTab('settings')">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    <span class="nav-label">è®¾ç½®</span>
  </button>
</nav>

<!-- TOAST -->
<div id="toast"></div>

<!-- DELETE DIALOG -->
<div class="dialog-overlay" id="del-dialog">
  <div class="dialog">
    <div class="dialog-title">ç¡®è®¤åˆ é™¤</div>
    <div class="dialog-msg" id="del-msg"></div>
    <div class="dialog-btns">
      <button class="dialog-cancel" onclick="closeDialog()">å–æ¶ˆ</button>
      <button class="dialog-confirm" onclick="confirmDelete()">åˆ é™¤</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IndexedDB  â€”  æ›¿ä»£ CSV æ–‡ä»¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB_NAME = 'WujindianDB', DB_VER = 1;
let _db = null;

function openDB() {
  if (_db) return Promise.resolve(_db);
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('inventory')) {
        const s = db.createObjectStore('inventory', { keyPath: 'id', autoIncrement: true });
        s.createIndex('name', 'name', { unique: true });
      }
      if (!db.objectStoreNames.contains('transactions')) {
        const s = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
        s.createIndex('date', 'date');
        s.createIndex('name', 'name');
      }
    };
    req.onsuccess = e => { _db = e.target.result; res(_db); };
    req.onerror = e => rej(e.target.error);
  });
}

function tx(store, mode = 'readonly') {
  return openDB().then(db => {
    const t = db.transaction(store, mode);
    return t.objectStore(store);
  });
}

function idbAll(store) {
  return tx(store).then(s => new Promise((res, rej) => {
    const req = s.getAll();
    req.onsuccess = () => res(req.result);
    req.onerror = e => rej(e.target.error);
  }));
}

function idbGet(store, key) {
  return tx(store).then(s => new Promise((res, rej) => {
    const req = s.get(key);
    req.onsuccess = () => res(req.result);
    req.onerror = e => rej(e.target.error);
  }));
}

function idbGetByIndex(store, idx, val) {
  return tx(store).then(s => new Promise((res, rej) => {
    const req = s.index(idx).get(val);
    req.onsuccess = () => res(req.result);
    req.onerror = e => rej(e.target.error);
  }));
}

function idbGetAllByIndex(store, idx, val) {
  return tx(store).then(s => new Promise((res, rej) => {
    const req = s.index(idx).getAll(val);
    req.onsuccess = () => res(req.result);
    req.onerror = e => rej(e.target.error);
  }));
}

function idbPut(store, obj) {
  return tx(store, 'readwrite').then(s => new Promise((res, rej) => {
    const req = s.put(obj);
    req.onsuccess = () => res(req.result);
    req.onerror = e => rej(e.target.error);
  }));
}

function idbAdd(store, obj) {
  return tx(store, 'readwrite').then(s => new Promise((res, rej) => {
    const req = s.add(obj);
    req.onsuccess = () => res(req.result);
    req.onerror = e => rej(e.target.error);
  }));
}

function idbDelete(store, key) {
  return tx(store, 'readwrite').then(s => new Promise((res, rej) => {
    const req = s.delete(key);
    req.onsuccess = () => res();
    req.onerror = e => rej(e.target.error);
  }));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Business Logic
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function getItem(name) {
  return idbGetByIndex('inventory', 'name', name);
}

async function processRestock(name, qty, price, unit, remark) {
  let item = await getItem(name);
  if (!item) {
    await idbAdd('inventory', { name, stock: 0, unit: unit || 'ä¸ª', cost: 0, remark: '' });
    item = await getItem(name);
  }
  item.stock = round2(item.stock + qty);
  item.cost = price;
  if (remark) item.remark = remark;
  await idbPut('inventory', item);
  return { ok: true, msg: 'è¿›è´§å½•å…¥æˆåŠŸ' };
}

async function processSale(name, qty, price, unit) {
  let item = await getItem(name);
  if (!item) {
    await idbAdd('inventory', { name, stock: 0, unit: unit || 'ä¸ª', cost: 0, remark: '' });
    item = await getItem(name);
  }
  item.stock = round2(item.stock - qty);
  await idbPut('inventory', item);

  const today = todayStr();
  const allTrans = await idbAll('transactions');
  const existing = allTrans.find(r => r.date === today && r.name === name);
  const total = round2(qty * price);
  const profit = round2((price - item.cost) * qty);

  if (existing) {
    existing.qty = round2(existing.qty + qty);
    existing.total = round2(existing.total + total);
    existing.profit = round2(existing.profit + profit);
    existing.price = price;
    await idbPut('transactions', existing);
  } else {
    await idbAdd('transactions', { date: today, name, qty, price, total, profit });
  }
  return { ok: true, msg: `å–å‡ºæˆåŠŸ  è¿›è´¦ Â¥${total}  åˆ©æ¶¦ Â¥${profit}` };
}

async function deleteTrans(id, syncStock) {
  if (syncStock) {
    const rec = await idbGet('transactions', id);
    if (rec) {
      const item = await getItem(rec.name);
      if (item) { item.stock = round2(item.stock + rec.qty); await idbPut('inventory', item); }
    }
  }
  await idbDelete('transactions', id);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CSV Import / Export
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function parseCSV(text) {
  const lines = text.replace(/\r/g, '').split('\n').filter(l => l.trim());
  if (lines.length < 2) return [];
  const headers = lines[0].replace(/^\uFEFF/, '').split(',').map(h => h.trim());
  return lines.slice(1).map(l => {
    const cols = l.split(',');
    const obj = {};
    headers.forEach((h, i) => obj[h] = (cols[i] || '').trim());
    return obj;
  });
}

async function importCSV(input, type) {
  const file = input.files[0];
  if (!file) return;
  const text = await file.text();
  const rows = parseCSV(text);
  let count = 0;
  if (type === 'inv') {
    for (const r of rows) {
      if (!r['å•†å“åç§°']) continue;
      const existing = await getItem(r['å•†å“åç§°']);
      if (existing) {
        existing.stock = parseFloat(r['åº“å­˜é‡']) || existing.stock;
        existing.unit = r['å•ä½'] || existing.unit;
        existing.cost = parseFloat(r['æˆæœ¬']) || existing.cost;
        existing.remark = r['å¤‡æ³¨'] || existing.remark;
        await idbPut('inventory', existing);
      } else {
        await idbAdd('inventory', {
          name: r['å•†å“åç§°'],
          stock: parseFloat(r['åº“å­˜é‡']) || 0,
          unit: r['å•ä½'] || 'ä¸ª',
          cost: parseFloat(r['æˆæœ¬']) || 0,
          remark: r['å¤‡æ³¨'] || ''
        });
      }
      count++;
    }
  } else {
    for (const r of rows) {
      if (!r['æ—¶é—´'] || !r['å•†å“åç§°']) continue;
      await idbAdd('transactions', {
        date: r['æ—¶é—´'].replace(/\//g, '-'),
        name: r['å•†å“åç§°'],
        qty: parseFloat(r['æ•°é‡']) || 0,
        price: parseFloat(r['å•ä»·']) || 0,
        total: parseFloat(r['æ€»ä»·']) || 0,
        profit: parseFloat(r['åˆ©æ¶¦']) || 0
      });
      count++;
    }
  }
  input.value = '';
  toast(`å¯¼å…¥æˆåŠŸï¼Œå…± ${count} æ¡è®°å½•`, 'ok');
  await refreshAll();
}

async function exportCSV(type) {
  let content, filename;
  if (type === 'inv') {
    const rows = await idbAll('inventory');
    const header = 'å•†å“åç§°,åº“å­˜é‡,å•ä½,æˆæœ¬,å¤‡æ³¨';
    const lines = rows.map(r => `${r.name},${r.stock},${r.unit},${r.cost},${r.remark || ''}`);
    content = '\uFEFF' + [header, ...lines].join('\n');
    filename = `åº“å­˜è¡¨_${todayStr()}.csv`;
  } else {
    const rows = await idbAll('transactions');
    const header = 'æ—¶é—´,å•†å“åç§°,æ•°é‡,å•ä»·,æ€»ä»·,åˆ©æ¶¦';
    const lines = rows.map(r => `${r.date},${r.name},${r.qty},${r.price},${r.total},${r.profit}`);
    content = '\uFEFF' + [header, ...lines].join('\n');
    filename = `æµæ°´è¡¨_${todayStr()}.csv`;
  }
  const blob = new Blob([content], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
  toast(`å¯¼å‡ºæˆåŠŸï¼š${filename}`, 'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allInv = [];
let allTrans = [];
let editingInvId = null;
let deletePendingId = null;
const UNITS = ['ä¸ª','æŠŠ','ç›’','å·','ç±³','åŒ…','ç®±','å¥—','æ ¹','æ¡','ç‰‡'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render: Inventory
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadInv() {
  allInv = await idbAll('inventory');
  allInv.sort((a, b) => a.name.localeCompare(b.name, 'zh'));
  populateRstSel();
  renderInv();
}

function renderInv() {
  const search = document.getElementById('inv-search').value.trim();
  const list = search ? allInv.filter(i => i.name.includes(search)) : allInv;

  document.getElementById('m-total').textContent = allInv.length;
  const lowCount = allInv.filter(i => i.stock < 5).length;
  const lowEl = document.getElementById('m-low');
  lowEl.textContent = lowCount;
  lowEl.className = 'metric-val ' + (lowCount > 0 ? 'red' : 'green');

  if (!list.length) {
    document.getElementById('inv-list').innerHTML =
      `<div class="empty-state"><span class="empty-icon">ğŸ“­</span><div class="empty-text">æš‚æ— å•†å“</div><div class="empty-sub">è¯·å…ˆè¿›è¡Œè¿›è´§å½•å…¥</div></div>`;
    return;
  }

  document.getElementById('inv-list').innerHTML = list.map(item => {
    const low = item.stock < 5;
    if (editingInvId === item.id) {
      return `<div class="item-row editing">
        <div style="flex:1">
          <div class="item-name">${item.name}</div>
          <div class="inline-edit" style="margin-top:8px">
            <div class="edit-group"><span class="edit-label">åº“å­˜</span><input class="edit-input" id="ei-stock" type="number" value="${item.stock}" step="0.1"></div>
            <div class="edit-group"><span class="edit-label">æˆæœ¬(å…ƒ)</span><input class="edit-input" id="ei-cost" type="number" value="${item.cost}" step="0.01"></div>
            <div class="edit-group"><span class="edit-label">å¤‡æ³¨</span><input class="edit-input" id="ei-remark" value="${item.remark||''}" style="width:80px"></div>
            <button class="save-btn" onclick="saveInvEdit(${item.id})">âœ“</button>
            <button class="save-btn" style="background:var(--muted)" onclick="editingInvId=null;renderInv()">âœ•</button>
          </div>
        </div>
      </div>`;
    }
    return `<div class="item-row${low?' low':''}" onclick="startInvEdit(${item.id})">
      <div style="flex:1">
        <div class="item-name">${item.name}</div>
        <div class="item-unit">${item.unit}${item.remark ? ' Â· ' + item.remark : ''}</div>
      </div>
      <div class="item-badges">
        <div class="badge badge-stock${low?' low':''}">
          <div class="badge-val">${item.stock}</div>
          <div class="badge-label">åº“å­˜</div>
        </div>
        <div class="badge badge-cost">
          <div class="badge-val" style="font-size:14px">Â¥${item.cost}</div>
          <div class="badge-label">æˆæœ¬</div>
        </div>
        ${low ? '<div class="low-alert">âš ï¸ è¡¥è´§</div>' : ''}
      </div>
    </div>`;
  }).join('');
}

function startInvEdit(id) { editingInvId = id; renderInv(); setTimeout(() => document.getElementById('ei-stock')?.focus(), 50); }

async function saveInvEdit(id) {
  const stock = parseFloat(document.getElementById('ei-stock').value) || 0;
  const cost = parseFloat(document.getElementById('ei-cost').value) || 0;
  const remark = document.getElementById('ei-remark').value;
  const item = await idbGet('inventory', id);
  if (!item) return;
  item.stock = stock; item.cost = cost; item.remark = remark;
  await idbPut('inventory', item);
  editingInvId = null;
  toast('å·²ä¿å­˜', 'ok');
  await loadInv();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Restock Form
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function populateRstSel() {
  const sel = document.getElementById('rst-sel');
  sel.innerHTML = `<option value="__new__">â• æ‰‹åŠ¨è¾“å…¥æ–°å•†å“</option>` +
    allInv.map(i => `<option value="${escAttr(i.name)}">${escHtml(i.name)}</option>`).join('');
  onRstSel();
}

async function onRstSel() {
  const val = document.getElementById('rst-sel').value;
  const isNew = val === '__new__';
  document.getElementById('rst-new').style.display = isNew ? '' : 'none';
  const infoEl = document.getElementById('rst-exist-info');
  if (!isNew) {
    const item = allInv.find(i => i.name === val);
    infoEl.style.display = '';
    infoEl.innerHTML = `<div class="info-pill">å·²é€‰ï¼š${item.name}ã€€å•ä½ï¼š${item.unit}ã€€å½“å‰æˆæœ¬ï¼šÂ¥${item.cost}</div>`;
    document.getElementById('rst-price').value = item.cost;
  } else {
    infoEl.style.display = 'none';
    document.getElementById('rst-price').value = '';
  }
}

function onRstUnit() {
  const sel = document.getElementById('rst-unit');
  document.getElementById('rst-unit-custom-wrap').style.display = sel.value === '__other' ? '' : 'none';
}

async function submitRestock() {
  const sel = document.getElementById('rst-sel').value;
  let name, unit;
  if (sel === '__new__') {
    name = document.getElementById('rst-name').value.trim();
    const u = document.getElementById('rst-unit').value;
    unit = u === '__other' ? document.getElementById('rst-unit-custom').value.trim() : u;
    if (!name) { toast('è¯·å¡«å†™å•†å“åç§°', 'err'); return; }
  } else {
    name = sel;
    const item = allInv.find(i => i.name === name);
    unit = item?.unit || 'ä¸ª';
  }
  const qty = parseFloat(document.getElementById('rst-qty').value) || 0;
  const price = parseFloat(document.getElementById('rst-price').value) || 0;
  const remark = document.getElementById('rst-remark').value.trim();
  const r = await processRestock(name, qty, price, unit, remark);
  toast(r.msg, r.ok ? 'ok' : 'err');
  // Reset
  document.getElementById('rst-sel').value = '__new__';
  document.getElementById('rst-name').value = '';
  document.getElementById('rst-qty').value = '';
  document.getElementById('rst-price').value = '';
  document.getElementById('rst-remark').value = '';
  onRstSel();
  await refreshAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Render: Transactions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadTrans() {
  allTrans = await idbAll('transactions');
  allTrans.sort((a, b) => (b.date > a.date ? 1 : -1));
  // Populate filter dropdowns
  const years = [...new Set(allTrans.map(r => r.date?.slice(0,4)))].filter(Boolean).sort().reverse();
  const months = [...new Set(allTrans.map(r => r.date?.slice(5,7) ? parseInt(r.date.slice(5,7)) : null))].filter(Boolean).sort((a,b)=>a-b);
  const dates = [...new Set(allTrans.map(r => r.date))].filter(Boolean).sort().reverse();

  const curY = document.getElementById('t-year').value;
  const curM = document.getElementById('t-month').value;
  const curD = document.getElementById('t-date').value;
  document.getElementById('t-year').innerHTML = `<option value="">å…¨éƒ¨å¹´ä»½</option>` + years.map(y => `<option value="${y}" ${y===curY?'selected':''}>${y}å¹´</option>`).join('');
  document.getElementById('t-month').innerHTML = `<option value="">å…¨éƒ¨æœˆä»½</option>` + months.map(m => `<option value="${String(m).padStart(2,'0')}" ${String(m).padStart(2,'0')===curM?'selected':''}>${m}æœˆ</option>`).join('');
  document.getElementById('t-date').innerHTML = `<option value="">å…¨éƒ¨æ—¥æœŸ</option>` + dates.map(d => `<option value="${d}" ${d===curD?'selected':''}>${d}</option>`).join('');
  renderTrans();
  populateSaleSel();
}

function renderTrans() {
  const search = document.getElementById('t-search').value.trim();
  const year = document.getElementById('t-year').value;
  const month = document.getElementById('t-month').value;
  const date = document.getElementById('t-date').value;

  let rows = allTrans;
  if (search) rows = rows.filter(r => r.name.includes(search));
  if (year) rows = rows.filter(r => r.date?.startsWith(year));
  if (month) rows = rows.filter(r => r.date?.slice(5,7) === month);
  if (date) rows = rows.filter(r => r.date === date);

  const totalRev = round2(rows.reduce((s, r) => s + (r.total||0), 0));
  const totalProfit = round2(rows.reduce((s, r) => s + (r.profit||0), 0));
  document.getElementById('m-rev').textContent = 'Â¥' + totalRev;
  const profEl = document.getElementById('m-profit');
  profEl.textContent = 'Â¥' + totalProfit;
  profEl.className = 'metric-val ' + (totalProfit >= 0 ? 'green' : 'red');
  document.getElementById('trans-count').textContent = `å…± ${rows.length} æ¡`;

  if (!rows.length) {
    document.getElementById('trans-list').innerHTML =
      `<div class="empty-state"><span class="empty-icon">ğŸ“­</span><div class="empty-text">æš‚æ— æµæ°´è®°å½•</div></div>`;
    return;
  }

  document.getElementById('trans-list').innerHTML = rows.map(r => `
    <div class="trans-row">
      <div class="trans-left">
        <div class="trans-date">${r.date}</div>
        <div class="trans-name">${escHtml(r.name)}</div>
        <div class="trans-meta">å•ä»· Â¥${r.price} Ã— ${r.qty} ä»¶</div>
      </div>
      <div class="trans-right">
        <div class="trans-total">Â¥${r.total}</div>
        <div class="trans-profit" style="color:${r.profit>=0?'var(--green)':'var(--red)'}">åˆ©æ¶¦ Â¥${r.profit}</div>
        <button class="btn btn-sm btn-danger-sm" style="margin-top:6px" onclick="askDelete(${r.id},'${escAttr(r.name)}',${r.qty})">åˆ é™¤</button>
      </div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Sale Form
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function populateSaleSel() {
  const sel = document.getElementById('sale-sel');
  sel.innerHTML = `<option value="">â€”â€” è¯·é€‰æ‹©å•†å“ â€”â€”</option><option value="__new__">â• æ‰‹åŠ¨è¾“å…¥æ–°å•†å“</option>` +
    allInv.map(i => `<option value="${escAttr(i.name)}">${escHtml(i.name)}</option>`).join('');
}

async function onSaleSel() {
  const val = document.getElementById('sale-sel').value;
  const isNew = val === '__new__';
  document.getElementById('sale-new').style.display = isNew ? '' : 'none';
  if (val && !isNew) {
    const item = allInv.find(i => i.name === val);
    // Try to prefill last sale price from history
    const hist = allTrans.filter(r => r.name === val);
    const lastPrice = hist.length ? hist[0].price : (item?.cost || 0);
    document.getElementById('sale-price').value = lastPrice;
  }
  document.getElementById('preview-box').style.display = val ? '' : 'none';
  updatePreview();
}

function updatePreview() {
  const qty = parseFloat(document.getElementById('sale-qty').value) || 0;
  const price = parseFloat(document.getElementById('sale-price').value) || 0;
  document.getElementById('preview-val').textContent = 'Â¥' + round2(qty * price).toFixed(2);
}

async function submitSale() {
  const sel = document.getElementById('sale-sel').value;
  let name, unit = 'ä¸ª';
  if (!sel) { toast('è¯·é€‰æ‹©å•†å“', 'err'); return; }
  if (sel === '__new__') {
    name = document.getElementById('sale-name').value.trim();
    unit = document.getElementById('sale-unit').value;
    if (!name) { toast('è¯·å¡«å†™å•†å“åç§°', 'err'); return; }
  } else {
    name = sel;
  }
  const qty = parseFloat(document.getElementById('sale-qty').value) || 0;
  const price = parseFloat(document.getElementById('sale-price').value) || 0;
  if (qty <= 0) { toast('æ•°é‡éœ€å¤§äº0', 'err'); return; }
  const r = await processSale(name, qty, price, unit);
  toast(r.msg, r.ok ? 'ok' : 'err');
  document.getElementById('sale-sel').value = '';
  document.getElementById('sale-new').style.display = 'none';
  document.getElementById('sale-qty').value = '1';
  document.getElementById('sale-price').value = '0';
  document.getElementById('preview-box').style.display = 'none';
  await refreshAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Delete Dialog
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function askDelete(id, name, qty) {
  deletePendingId = id;
  const sync = document.getElementById('sync-toggle').checked;
  document.getElementById('del-msg').textContent =
    `ç¡®å®šåˆ é™¤ã€Œ${name}ã€çš„è¿™æ¡æµæ°´è®°å½•å—ï¼Ÿ` + (sync ? '\n\nåŒæ—¶å°†æ¢å¤ ' + qty + ' ä»¶åº“å­˜ã€‚' : '');
  document.getElementById('del-dialog').classList.add('open');
}
function closeDialog() { document.getElementById('del-dialog').classList.remove('open'); }
async function confirmDelete() {
  if (!deletePendingId) return;
  const sync = document.getElementById('sync-toggle').checked;
  await deleteTrans(deletePendingId, sync);
  deletePendingId = null;
  closeDialog();
  toast(sync ? 'å·²åˆ é™¤å¹¶æ¢å¤åº“å­˜' : 'å·²åˆ é™¤', 'ok');
  await refreshAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Navigation
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function switchTab(tab) {
  ['inv','trans','settings'].forEach(t => {
    document.getElementById('page-' + t).classList.toggle('active', t === tab);
    document.getElementById('nav-' + t).classList.toggle('on', t === tab);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Toast
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer = null;
function toast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.className = '', 2600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Utils
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function round2(n) { return Math.round(n * 100) / 100; }
function todayStr() { return new Date().toISOString().slice(0,10); }
function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escAttr(s) { return String(s).replace(/"/g,'&quot;'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Guide Data
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GUIDES = [
  {icon:'ğŸ“¦', title:'æŸ¥çœ‹åº“å­˜', desc:'åº“å­˜é¡µæ˜¾ç¤ºæ‰€æœ‰å•†å“ï¼Œä½äº5ä»¶è‡ªåŠ¨çº¢è‰²é«˜äº®æé†’è¡¥è´§'},
  {icon:'âœï¸', title:'ç¼–è¾‘åº“å­˜', desc:'ç‚¹å‡»åº“å­˜åˆ—è¡¨ä¸­ä»»æ„å•†å“ï¼Œç›´æ¥ä¿®æ”¹åº“å­˜æ•°é‡å’Œæˆæœ¬ä»·'},
  {icon:'ğŸ“¥', title:'è¿›è´§å½•å…¥', desc:'é€‰æ‹©å·²æœ‰å•†å“æˆ–æ–°å»ºå•†å“ï¼Œå¡«å†™è¿›è´§é‡å’Œå•ä»·åç¡®è®¤'},
  {icon:'ğŸ“¤', title:'å–å‡ºç™»è®°', desc:'é€‰å•†å“ã€å¡«æ•°é‡å’Œå”®ä»·ï¼Œç³»ç»Ÿè‡ªåŠ¨è®¡ç®—åˆ©æ¶¦å¹¶åˆå¹¶å½“æ—¥æµæ°´'},
  {icon:'ğŸ”', title:'æµæ°´ç­›é€‰', desc:'å¯æŒ‰å¹´ã€æœˆã€å…·ä½“æ—¥æœŸç­›é€‰ï¼Œå®æ—¶æ˜¾ç¤ºè¥ä¸šé¢å’Œåˆ©æ¶¦'},
  {icon:'ğŸ’¾', title:'æ•°æ®å¤‡ä»½', desc:'è®¾ç½®é¡µå¯å¯¼å‡ºCSVå¤‡ä»½ï¼Œä¹Ÿå¯å¯¼å…¥ä»¥å‰çš„å†å²æ•°æ®'},
  {icon:'ğŸ“²', title:'æ·»åŠ åˆ°æ¡Œé¢', desc:'æµè§ˆå™¨ç‚¹"åˆ†äº«"â†’"æ·»åŠ åˆ°ä¸»å±å¹•"ï¼Œå³å¯åƒAppä¸€æ ·ä»æ¡Œé¢æ‰“å¼€'},
];

function renderGuide() {
  document.getElementById('guide-list').innerHTML = GUIDES.map(g =>
    `<div class="guide-item">
       <div class="guide-icon-wrap">${g.icon}</div>
       <div><div class="guide-title">${g.title}</div><div class="guide-desc">${g.desc}</div></div>
     </div>`
  ).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Header date
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateDate() {
  const d = new Date();
  const w = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()];
  document.getElementById('hdr-date').textContent = `${d.getMonth()+1}/${d.getDate()} å‘¨${w}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Refresh All
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function refreshAll() {
  await loadInv();
  await loadTrans();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async () => {
  updateDate();
  renderGuide();
  await openDB();
  await refreshAll();

  // PWA Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
  }
})();
</script>
</body>
</html>
